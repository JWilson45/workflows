name: Clean PR images (GHCR)

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: "Repository name / GHCR image name (container package name, without ghcr.io/owner/)"
        required: true
        type: string
      owner:
        description: "Package owner (org or user). Defaults to repository owner."
        required: false
        type: string
      owner_type:
        description: "Set to 'org' if the package is owned by an organization; otherwise 'user'."
        required: false
        default: "user"
        type: string
      dry_run:
        description: "If true, prints what would be deleted but does not delete."
        required: false
        default: true
        type: boolean
      runner:
        description: "GitHub Actions runner label"
        required: false
        default: "ubuntu-latest"
        type: string

jobs:
  cleanup:
    runs-on: ${{ github.event.inputs.runner || 'ubuntu-latest' }}
    permissions:
      packages: write
      contents: read

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${{ github.event.inputs.repository_name }}" ]]; then
            echo "repository_name is required" >&2
            exit 1
          fi

          if [[ "${{ github.event.inputs.owner_type }}" != "user" && "${{ github.event.inputs.owner_type }}" != "org" ]]; then
            echo "owner_type must be 'user' or 'org'" >&2
            exit 1
          fi

      - name: Delete PR-tagged GHCR package versions
        env:
          GH_TOKEN: ${{ github.token }}
          OWNER: ${{ github.event.inputs.owner || github.repository_owner }}
          OWNER_TYPE: ${{ github.event.inputs.owner_type || 'user' }}
          IMAGE: ${{ github.event.inputs.repository_name }}
          DRY_RUN: ${{ github.event.inputs.dry_run || false }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${IMAGE:-}" ]]; then
            echo "package_name is required (IMAGE env is empty)" >&2
            exit 1
          fi

          # Match ANY PR-related tags of the form: -pr<digits>-
          MODE="manual"
          TAG_REGEX="-pr[0-9]+-"

          # GHCR versions endpoint differs for user vs org packages
          if [[ "${OWNER_TYPE}" == "org" ]]; then
            VERSIONS_ENDPOINT="/orgs/${OWNER}/packages/container/${IMAGE}/versions"
          else
            VERSIONS_ENDPOINT="/users/${OWNER}/packages/container/${IMAGE}/versions"
          fi

          echo "Mode:       ${MODE}"
          echo "Owner:      ${OWNER} (${OWNER_TYPE})"
          echo "Package:    ${IMAGE}"
          echo "Tag regex:  ${TAG_REGEX}"
          echo "Endpoint:   ${VERSIONS_ENDPOINT}"
          echo "Dry run:    ${DRY_RUN}"

          {
            echo "## GHCR cleanup"
            echo "- **Mode:** ${MODE}"
            echo "- **Owner:** ${OWNER} (${OWNER_TYPE})"
            echo "- **Package:** ${IMAGE}"
            echo "- **Tag regex:** \`${TAG_REGEX}\`"
            echo "- **Dry run:** ${DRY_RUN}"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Build a report of matching versions with the specific matching tags.
          # Output format: <id>\t<tag1,tag2,...>
          report=$(gh api "${VERSIONS_ENDPOINT}" --paginate --jq "
            .[]
            | . as \$v
            | [(.metadata.container.tags // [])[] | select(test(\"${TAG_REGEX}\"))] as \$mt
            | select((\$mt|length) > 0)
            | (\$v.id|tostring) + \"\\t\" + (\$mt|join(\",\"))
          ")

          if [[ -z "${report}" ]]; then
            echo "No matching versions found. Nothing to delete."
            echo "âœ… No matching versions found. Nothing to delete." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "Matched versions (version_id\tmatching_tags):"
          echo "${report}"

          {
            echo "### Matched versions"
            echo "| Version ID | Matching tags |"
            echo "|---:|---|"
            while IFS=$'\t' read -r vid mtags; do
              [[ -z "${vid}" ]] && continue
              echo "| ${vid} | ${mtags} |"
            done <<< "${report}"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Extract unique version IDs
          ids=$(printf "%s\n" "${report}" | cut -f1 | sort -u)

          if [[ "${DRY_RUN}" == "true" ]]; then
            echo "DRY RUN enabled; skipping deletion."
            echo "ðŸ§ª **Dry run**: no deletions performed." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "Deleting matching versions..."
          deleted_count=0
          while read -r id; do
            [[ -z "${id}" ]] && continue
            gh api --method DELETE "${VERSIONS_ENDPOINT}/${id}"
            echo "Deleted version ${id}"
            deleted_count=$((deleted_count+1))
          done <<< "${ids}"

          echo "Deleted ${deleted_count} version(s)."
          echo "ðŸ—‘ï¸ Deleted **${deleted_count}** version(s)." >> "$GITHUB_STEP_SUMMARY"