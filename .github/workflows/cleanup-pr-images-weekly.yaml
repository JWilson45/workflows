name: Cleanup GHCR PR Images Weekly

on:
  schedule:
    - cron: "20 16 * * 0"
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  dispatch-cleanup:
    runs-on: workflows-runner-set
    steps:
      - name: Dispatch cleanup workflow with weekly inputs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dispatchRef =
              context.payload?.repository?.default_branch ||
              process.env.GITHUB_REF_NAME ||
              "main";
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "cleanup-pr-images.yaml",
              ref: dispatchRef,
              inputs: {
                image_name: "ghcr.io/JWilson45/mmmodern-web,ghcr.io/JWilson45/mmmodern-api,ghcr.io/JWilson45/mm",
                pr_numbers: "",
                older_than_days: "7",
                require_approval: "false",
              },
            });
            core.info(`Dispatched cleanup-pr-images.yaml on ref ${dispatchRef} with weekly inputs.`);
