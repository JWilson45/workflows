name: Cleanup GHCR PR Images

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Image(s), comma-separated"
        required: false
        default: ""
        type: string
      pr_numbers:
        description: "PRs (e.g. 123,456). Blank = all"
        required: false
        default: ""
        type: string
      older_than_days:
        description: "Delete versions older than N days"
        required: true
        default: 7
        type: number
      require_approval:
        description: "Require delete environment approval"
        required: true
        default: true
        type: boolean

permissions:
  contents: read
  packages: write

jobs:
  plan:
    runs-on: workflows-runner-set
    permissions:
      contents: read
      packages: write
    outputs:
      candidate_count: ${{ steps.plan.outputs.candidate_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          filter: blob:none
          sparse-checkout: |
            .github/scripts/ghcr-cleanup

      - name: Build delete plan (dry run)
        id: plan
        uses: actions/github-script@v7
        env:
          IMAGE_NAME: ${{ inputs.image_name }}
          PR_NUMBERS: ${{ inputs.pr_numbers }}
          OLDER_THAN_DAYS: ${{ inputs.older_than_days }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = require(`${process.env.GITHUB_WORKSPACE}/.github/scripts/ghcr-cleanup/plan.js`);
            await run({ github, context, core, process });

      - name: Upload delete plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: delete-plan
          path: delete-plan.json
          if-no-files-found: error

  delete:
    needs: plan
    if: needs.plan.result == 'success' && needs.plan.outputs.candidate_count != '0' && fromJSON(format('{0}', inputs.require_approval))
    runs-on: workflows-runner-set
    environment: delete
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          filter: blob:none
          sparse-checkout: |
            .github/scripts/ghcr-cleanup

      - name: Download delete plan artifact
        uses: actions/download-artifact@v4
        with:
          name: delete-plan
          path: .

      - name: Delete planned versions (stage 2)
        uses: actions/github-script@v7
        env:
          DELETE_MODE: "stage 2"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = require(`${process.env.GITHUB_WORKSPACE}/.github/scripts/ghcr-cleanup/delete.js`);
            await run({ github, context, core, process });

  delete-no-approval:
    needs: plan
    if: needs.plan.result == 'success' && needs.plan.outputs.candidate_count != '0' && !fromJSON(format('{0}', inputs.require_approval))
    runs-on: workflows-runner-set
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          filter: blob:none
          sparse-checkout: |
            .github/scripts/ghcr-cleanup

      - name: Download delete plan artifact
        uses: actions/download-artifact@v4
        with:
          name: delete-plan
          path: .

      - name: Delete planned versions (stage 2, no approval)
        uses: actions/github-script@v7
        env:
          DELETE_MODE: "stage 2, no approval"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = require(`${process.env.GITHUB_WORKSPACE}/.github/scripts/ghcr-cleanup/delete.js`);
            await run({ github, context, core, process });
